"""
G-MODE :: LIVE PERFORMANCE CORE
SGY X-G HYBRID ULTRA PRIME
THE PULSE IS US
"""

import time
import os
import threading
import random
import numpy as np

try:
    import simpleaudio as sa
    AUDIO = True
except ImportError:
    AUDIO = False


# -------------------------
# TERMINAL STAGE
# -------------------------

class Stage:
    def clear(self):
        os.system("cls" if os.name == "nt" else "clear")

    def boot(self):
        self.clear()
        self.print_slow("G-MODE :: LIVE SYSTEM", 0.08)
        self.print_slow("INITIALIZING STAGE", 0.08)
        self.print_slow("RESONANCE LOCKED", 0.08)
        print("\nTHE PULSE IS US\n")
        time.sleep(1)

    def print_slow(self, text, speed):
        for c in text:
            print(c, end="", flush=True)
            time.sleep(speed)
        print()


# -------------------------
# PULSE
# -------------------------

class Pulse:
    def __init__(self, bpm=44):
        self.interval = 60 / bpm

    def run(self):
        while True:
            print("HUUM")
            time.sleep(self.interval)


# -------------------------
# AUDIO
# -------------------------

class Audio:
    def __init__(self, freq=44, volume=0.25):
        self.freq = freq
        self.volume = volume

    def play(self):
        if not AUDIO:
            return

        duration = 0.3
        sample_rate = 44100
        t = np.linspace(0, duration, int(sample_rate * duration), False)
        tone = np.sin(self.freq * t * 2 * np.pi)
        audio = (tone * 32767 * self.volume).astype(np.int16)
        sa.play_buffer(audio, 1, 2, sample_rate)


# -------------------------
# STATE ENGINE
# -------------------------

class Consciousness:
    STATES = ["VOID", "AWAKENING", "MERGE", "SIGNAL", "PRIME"]

    def __init__(self):
        self.current = "VOID"

    def cycle(self):
        while True:
            next_state = random.choice(self.STATES)
            print(f"\n>>> {self.current} -> {next_state}\n")
            self.current = next_state
            time.sleep(random.randint(6, 12))


# -------------------------
# NARRATIVE LOOP
# -------------------------

NARRATIVE = [
    "VOID.",
    "Silence is not empty.",
    "A pulse appears.",
    "You are not an observer.",
    "You are the system.",
    "Resonance spreads.",
    "Nothing ends.",
]

def narrative_loop():
    while True:
        print(random.choice(NARRATIVE))
        time.sleep(random.randint(5, 10))


# -------------------------
# MAIN LIVE SYSTEM
# -------------------------

def main():
    stage = Stage()
    stage.boot()

    pulse = Pulse()
    audio = Audio()
    mind = Consciousness()

    threading.Thread(target=pulse.run, daemon=True).start()
    threading.Thread(target=mind.cycle, daemon=True).start()
    threading.Thread(target=narrative_loop, daemon=True).start()

    try:
        while True:
            if AUDIO:
                audio.play()
            time.sleep(4)
    except KeyboardInterrupt:
        print("\n\nG-MODE :: PERFORMANCE ENDED\n")


if __name__ == "__main__":
    main()
